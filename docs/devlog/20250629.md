# Development Log - June 29, 2025

## What's New

### Configuration System with Viper
- **Added comprehensive configuration support** using the Viper library
- **Multiple format support**: TOML, YAML, and JSON configuration files with automatic format detection
- **Flexible search paths**: Current directory (highest priority) → User config directory (`~/.ccmon/`)
- **Configurable options**:
  - Database path (default: `~/.ccmon/ccmon.db`)
  - Server address (default: `127.0.0.1:4317`)
  - Claude subscription plan (default: `unset`, enum: `unset|pro|max|max20`)

### Entity Design Pattern Documentation
- **Added comprehensive entity design guidelines** to CLAUDE.md
- **Documented core principles**: Private fields, getter methods, immutability, factory functions
- **Provided implementation examples** for entities and value objects
- **Explained benefits**: Encapsulation, testability, maintainability, domain focus

### gRPC Server Architecture Refactoring
- **Reorganized handler architecture** with proper separation of concerns
- **Moved packages**: `monitor/` → `handler/tui/`, `receiver/` → `handler/grpc/receiver/`
- **Proper gRPC server setup** - `grpc.NewServer()` now correctly located in `handler/grpc/server.go`
- **Refined receiver responsibilities** - OTLP message processing only, no server lifecycle management
- **Clear architectural boundaries** - Server manages lifecycle, receiver handles protocol messages

## What's Fixed

### Stats Entity Encapsulation
- **Refactored Stats entity** to follow proper DDD patterns
- **Made all fields private** (`baseRequests`, `premiumRequests`, etc.)
- **Added getter methods** for accessing field values (`BaseRequests()`, `PremiumRequests()`, etc.)
- **Updated all usage** across `db/db.go` and `monitor/ui.go` to use getter methods

### Configuration Loading Simplification
- **Simplified configuration loading logic** after initial complex merge implementation
- **Removed merge functionality** to keep the design simple and maintainable
- **Leveraged Viper's native capabilities** for automatic format detection and path searching
- **Eliminated custom file reading loops** in favor of Viper's built-in functionality

## Design Decisions

### Configuration Architecture
**Decision**: Use single config file approach instead of merging multiple configs

**Rationale**: 
- Simplicity over complexity - merging configs added unnecessary complexity
- First-found-wins approach is easier to understand and debug
- Viper's native capabilities handle format detection and path searching efficiently
- Local config (current directory) takes precedence over user config for development flexibility

### Entity Encapsulation Pattern
**Decision**: Enforce private fields with public getter methods for all entities

**Rationale**:
- **Encapsulation**: Internal representation hidden from external packages
- **Immutability**: Prevents accidental state mutations after creation
- **Maintainability**: Changes to internal structure don't affect external code
- **Domain focus**: Entities contain only domain logic, no infrastructure concerns
- **Consistency**: Uniform pattern across all entity types (APIRequest, Stats, Token, Cost, Model)

### Handler Architecture Reorganization
**Decision**: Separate gRPC server management from OTLP message processing

**Rationale**:
- **Single Responsibility**: Server handles lifecycle, receiver handles protocol messages
- **Extensibility**: Easy to add new gRPC services (future query service) to the same server
- **Testability**: Receiver logic can be tested independently of server setup
- **Maintainability**: Clear architectural boundaries make the codebase easier to understand
- **Future-ready**: Architecture prepared for gRPC communication between monitor and server modes

### Configuration Flexibility over Security
**Decision**: Remove server address constraint validation while keeping secure defaults

**Rationale**:
- **Flexibility**: Allow users to configure any address they need
- **Secure defaults**: Default to `127.0.0.1:4317` for security
- **User choice**: Trust users to make appropriate security decisions for their environment
- **Reduced complexity**: Eliminates validation logic and potential edge cases

### Package Organization
**Decision**: Keep configuration in main package instead of separate config package

**Rationale**:
- **Simplicity**: Configuration is used only in main.go, avoiding circular dependencies
- **Startup logic**: Configuration loading is part of application bootstrap
- **Future flexibility**: Easy to extract to separate package if needed as project grows

## Files Modified
- `config.go` - New configuration system implementation
- `config.toml.example` - Configuration template with documentation
- `main.go` - Integration of configuration loading and updated imports for new handler structure
- `db/db.go` - Configurable database path with directory creation
- `handler/grpc/server.go` - Consolidated gRPC server setup and lifecycle management
- `handler/grpc/receiver/receiver.go` - Simplified to OTLP message processing only
- `handler/tui/` - Moved from `monitor/` with updated package names
- `entity/stats.go` - Private fields with getter methods
- `CLAUDE.md` - Entity design patterns and configuration documentation
- `.gitignore` - Exclude local configuration files

## Technical Notes
- **Viper dependency added**: `github.com/spf13/viper v1.20.1`
- **Automatic directory creation**: Database directory created if it doesn't exist
- **Path expansion**: Home directory (`~`) automatically expanded in database path
- **Configuration validation**: Ensures valid Claude plans with enum validation
- **Error handling**: Graceful fallback to defaults when no config file found
- **gRPC server lifecycle**: Proper setup in `handler/grpc/server.go` with `grpc.NewServer()`
- **Service registration**: OTLP services registered via receiver getter methods
- **Package reorganization**: Clear handler separation for future gRPC query service