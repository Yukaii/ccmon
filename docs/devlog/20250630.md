# Development Log - June 30, 2025

## What's Fixed

### Time Block Logic Simplification
- **Fixed incorrect time block calculation** where `9:46am` with `-b 10am` was showing `"6am - 11am"` instead of the expected `"10am - 3pm"`
- **Removed complex yesterday/today reference logic** that was causing confusion and edge cases
- **Eliminated "too early" error handling** - the system now always returns a valid block (either current or upcoming)
- **Fixed static block behavior** - blocks now automatically advance as time progresses without requiring restart

## What's New

### Automatic Block Advancement
- **Added `NextBlock(now)` method** to Block entity for seamless time progression
- **Integrated automatic block updates** in TUI refresh cycle - blocks now advance automatically every 5 hours
- **Simplified Block entity design** using concrete `startAt` timestamp instead of `startHour + timezone` pattern

### Enhanced User Experience
- **Always-valid blocks** - no more error messages when using block tracking at any time
- **Real-time block progression** - the displayed block automatically updates as 5-hour periods pass
- **Predictable 5-hour sliding windows** based on user's specified start time

### Auto-Width Table Columns
- **Dynamic column sizing** - table columns now automatically adjust to terminal width
- **Intelligent space distribution** - Model column gets 50% of extra space for long model names
- **Responsive compact mode** - narrow terminals combine Cache/Total columns for better fit
- **No model name truncation** - full model names display when space allows

## Design Decisions

### Value Object Pattern for Block Entity
- **Concrete timestamps over calculated references** - Block now stores `startAt time.Time` directly
- **Immutable block progression** - `NextBlock()` returns new Block instances rather than modifying existing ones
- **Encapsulated time calculations** - all block logic contained within the Block entity

### Simplified Time Logic
- **Delta-based calculations** - determine current block by calculating time difference from user's start hour
- **Automatic yesterday/today handling** - when current time is before start hour but within reasonable range (12+ hours), automatically use previous day's reference
- **Removed error states** - always show either current active block or next upcoming block

### Testing Strategy
- **Focused on core scenarios** - removed complex edge case tests that were testing implementation details rather than business logic
- **Added NextBlock method tests** - comprehensive coverage of automatic block advancement behavior
- **Maintained test coverage** at 57.9% for entity layer

### Auto-Width Table Design
- **Similar to Usage Statistics** - follows same pattern as existing auto-width stats section
- **Proportional space distribution** - Model column prioritized with 50% of extra space
- **Overhead accounting** - considers borders and padding in width calculations
- **Responsive breakpoints** - compact mode activated below 80 character width

### Model Validation & Resilience
- **Added `NewModel` constructor** with validation for creating Model entities
- **Implemented resilient fallback behavior** - invalid model names now default to "unknown" instead of causing errors
- **Enhanced telemetry reliability** - ensures API request creation never fails due to unexpected model names from Claude Code
- **Comprehensive test coverage** - added `entity/model_test.go` with table-driven tests for all validation scenarios

### Code Cleanup & Architecture
- **Removed unused `TimeFilter` types** from repository schema package
- **Eliminated dead code** - cleaned up obsolete filtering logic in favor of `entity.Period`
- **Clarified architecture boundaries** - time filtering now exclusively handled in presentation layer
- **Moved token limits** from Stats entity to Block entity for better separation of concerns

## Design Decisions

### Resilient Model Creation
- **Graceful degradation over strict validation** - chose to return "unknown" instead of errors for monitoring robustness
- **YAGNI principle applied** - avoided adding speculative methods like `IsPremium()` or `ModelFamily()`
- **Factory function pattern** - `NewModel()` centralizes validation logic and ensures consistent behavior

### Entity Responsibility Separation
- **Block-centric token limits** - moved `MaxTokens()` from Stats to Block entity where it logically belongs
- **Immutable value objects** - maintained DDD principles with private fields and getter methods
- **Clear entity boundaries** - Stats focuses on calculated metrics, Block handles time-based constraints

### Code Quality & Maintenance
- **Dead code elimination** - removed unused schema types that were duplicating TUI functionality
- **Architecture clarification** - filtering responsibility clearly assigned to presentation layer
- **Test-driven development** - comprehensive test coverage for new Model validation logic

## Impact

### Time Block Improvements
This refactoring addresses the primary user complaint about confusing time block behavior and provides a much more intuitive experience. The automatic advancement feature ensures users always see accurate, up-to-date block information without manual intervention.

### Table Display Enhancement
The auto-width table columns significantly improve readability of long Claude model names across different terminal sizes. Users can now see full model names without truncation on medium and wide terminals, while narrow terminals get a compact but still readable layout. This matches the professional look and feel of the Usage Statistics section.

### Telemetry Reliability
The resilient Model creation ensures that unexpected model names from Claude Code telemetry never cause data loss or application failures. The "unknown" fallback provides visibility into unrecognized models while maintaining system stability.

### Codebase Health
Cleanup of unused code and proper entity responsibility separation improves maintainability and reduces cognitive overhead for developers. The architecture now more clearly separates concerns between data persistence, business logic, and presentation layers.

## Latest Updates (Evening Session)

### What's Fixed
- **Period Entity Time Dependencies**: Removed system time dependencies from Period entity constructors
- **Model Length Validation**: Eliminated unnecessary 3-character minimum length requirement for model names
- **Timezone Complexity**: Simplified timezone handling by removing `NewPeriodFromDurationWithTimezone` function

### What's New
- **Pure Entity Design**: Period entity now follows clean architecture with dependency injection for time parameters
- **Simplified Period Creation**: UTC-only period creation with timezone handling moved to presentation layer

### Design Decisions

#### Period Entity Refactoring
- **From**: Entity with system dependencies calling `time.Now()` internally
- **To**: Pure entity accepting time parameters via constructor
- **Benefits**: Testable, no side effects, flexible time source control

#### Timezone Architecture Simplification
- **Decision**: Remove timezone complexity from entity layer
- **Implementation**: Timezone now only used for display formatting in UI
- **Impact**: Cleaner separation of concerns, simpler mental model

#### Model Validation Cleanup  
- **Removed**: Arbitrary 3-character minimum length constraint
- **Kept**: Empty/whitespace validation with "unknown" fallback
- **Rationale**: More flexible while maintaining data integrity

### Architecture Enhancement

The Period entity now exemplifies proper DDD patterns:

```go
// Clean Architecture - Accept dependencies via parameters
func NewPeriodFromDuration(now time.Time, duration time.Duration) Period

// Previous - System dependency embedded in entity  
func NewPeriodFromDuration(duration time.Duration) Period // Called time.Now()
```

This makes entities:
- **Pure**: No system dependencies or side effects
- **Testable**: Time can be injected for any test scenario  
- **Flexible**: Caller controls the time source

### Files Updated
- `entity/period.go` - Removed timezone complexity, simplified constructors
- `entity/model.go` - Removed minimum length validation  
- `handler/tui/view_model.go` - Updated to inject time parameters
- `handler/grpc/query/service.go` - Updated Period usage
- `repository/grpc_api_request_repository.go` - Updated Period usage  
- `CLAUDE.md` - Updated documentation and examples